## Description

Turanga — это [opds](https://ru.wikipedia.org/wiki/OPDS)-сервер с веб-интерфейсом, обеспечивающий анонимный обмен книгами через [ipfs](https://ru.wikipedia.org/wiki/IPFS) с сигнализацией через узлы [nostr](https://en.wikipedia.org/wiki/Nostr); использует для работы базу данных [sqlite](https://ru.wikipedia.org/wiki/SQLite).

## Intro

Когда спустя некоторое время после безвременной кончины Стивера прекратил своё существование сайт **flibusta** (тогда казалось, что навсегда), это оказалось для меня неожиданно сильным ударом. На флибусте я привык искать нужные мне книги (а я запойный читатель с детских лет) и закрытие сайта, можно сказать, потрясло меня. Конечно, есть и другие сайты-библиотеки, да и флибуста вскоре ожила с помощью добрых людей, но осталось ощущение хрупкости бытия её и ей подобных. Пришла идея распределённой библиотеки, когда каждый её пользователь хранит у себя только интересные ему книги и делится ими по запросу коллеги; у каждого свои вкусы, "кто любит попа, кто попадью, а кто свиной хрящик", и таким образом всё множество книг хранится у его читателей. Не лишней была бы и анонимизация пользователей, в свете буйства правооблядателей. Я нашёл несколько распределённых систем хранения видео, но ни одной — книг, и эта идея так и пропала бы в нетях, не появись в нашем мире разнообразные Искусственные Разумы, в том числе и умеющие писать код. Не очень веря в успех, я попробовал поиграться с одним из них — Qwen3-Coder, на удивление, дело пошло, и вот я представляю наше творение.

Имя было дано — Turanga, в честь футурамского персонажа Туранги Лилы — командира Межпланетного Экспресса (отсылка к InterPlanetary File System) родом из ньюньюйоркского подземелья (ipfs и nostr тоже не запрещены, но как бы невидимы в повсеместном вебе). Книги обычно читают с ридеров, а те умеют обращаться за книгами к серверам opds, и программа является таким домашним сервером; для управления содержимым у неё сделан веб-интерфейс, чтобы можно было управлять из любого браузера.

ipfs выбран в качестве системы хранения за свою скорость вхождения в сеть за несколько секунд, i2p и tor для этого требуются минуты и десятки минут. Про nostr я раньше и не знал, использовать его предложил AI, а sqlite — традиционная база данных для небольших проектов.

В отличие от той же **calibre**, где книга это некое логическое понятие, у которого может быть несколько файлов различных форматов, здесь всё проще — книгой считается файл; файлы разных форматов с одинаковым содержимым это разные книги.

У книги можно менять метаданные — автора, название, обложку, аннотацию, выходные данные; всё это сохраняется в базе данных и вспомогательных файлах, сам файл книги остаётся неизменным. Неизменность файла книги позволило ввести использование его хеша (выбран xxhash за скорость вычисления) для идентификации. Сделана система тегов, позволяющая произвольно выделять и группировать книги с их помощью; у каждой книги их может быть несколько. Есть флажок ограничения доступа с которым книга будет недоступна в opds. В opds также не передаются книги форматов pdf и djvu, только fb2, fb2.zip и epub.

Отличительная фишка программы — возможность запросить книгу через интернет. В этом случае запрос (фамилия автора, или часть названия/серии, или хеш) уходит на сервера nostr и ими передаётся другим турангам, те автоматически отсылают список имеющихся у них книг, удовлетворяющих запросу, и запросивший может скачать из них те, что ему интересны. Для идентификации на серверах nostr используются публичные ключи, которые генерируются при первом запуске программы. В любой момент можно сгенерировать новый, стерев приватный ключ из файла конфигурации и перезапустив программу, но это ведёт к потере бонусов, описанных ниже. Для ограничения трафика можно поставить ограничение запросов от одного пользователя, после превышения которого программа ему отвечать не будет в течение суток. Библиотеки, имеющие много книг и находящихся онлайн долгое время, могут принести своему хозяину своеобразный бонус — каждая скачанная у них книга увеличивает для него у скачавшего предел ограничения на единицу навсегда; т.е. если у А выставлен предел запросов 1, но он скачал у Б 5 книг, то программа А может ответить Б шесть раз в сутки.

С целью противодействия возможным деструктивным действиям есть возможность добавить злоумышленника, посылающего плохие книги, в "чёрный список", в этом случае ни книги, ни запросы от него не будут обрабатываться на этом компьютере.

## Prerequiments

Turanga вполне может раздавать книги самостоятельно, без дополнительных программ, но возможности импорта книг в этом случае будут сильно ограничены, фактически более-менее полноценно будут обрабатываться только файлы типа **fb2** (сиречь кастомизированный xml).

Для поддержки **fb2.zip** и **epub** необходимы [zip.exe](https://gnuwin32.sourceforge.net/packages/zip.htm) и [unzip.exe](https://gnuwin32.sourceforge.net/packages/unzip.htm), их нужно положить в папку, упомянутую в %PATH%.

Чтобы появилась поддержка **pdf** необходимы утилиты [poppler](https://github.com/oschwartz10612/poppler-windows); папку bin из архива надо тоже положить куда-нибудь в %PATH%, или дописать путь к ним в %PATH%. Эти утилиты для своей работы требуют [vc_redist.x64.exe](https://learn.microsoft.com/ru-ru/cpp/windows/latest-supported-vc-redist?view=msvc-170)

Для поддержки **djvu** необходимо установить [DjVuLibre](https://sourceforge.net/projects/djvu/files/); необходимый ему vcredist он тащит с собой, несовместимый с нужным poppler'у, но к счастью другой разрядности, так что они друг другу не мешают.

Поскольку папку с утилитами poppler всё равно надо прописывать в %PATH%, удобно туда же положить и zip.exe с unzip.exe.

Пользователи Linux лишены сомнительного удовольствия этого виндосекса, необходимые утилиты есть в репозиториях и устанавливаются командой

`sudo apt install zip, unzip, poppler-utils, djvulibre-bin` (пример для Linux Mint, как одного из самых распространённых)

И наконец для возможности обмена файлами книг нужно перед запуском turanga запускать [ipfs](https://github.com/ipfs/kubo). У компьютера должен быть доступ в интернет без прокси, иначе ipfs не работает :(

**btw**: *см. папку res*

## Installation

Итак, весь необходимый софт установлен, %PATH% поправлен, компьютер перезагружен.

**ipfs** при первом запуске без параметров или с параметром *init* создаёт свой рабочий каталог в домашнем каталоге пользователя который его запускал. Там находится файл конфигурации который надо подправить, можно в редакторе каком-либо, но проще через командную строку.

В одном окне запускаем `ipfs daemon`, в другом посылаем команды (нужно сделать один раз при настройке):

`ipfs config --json Experimental.FilestoreEnabled true` — чтобы файлы книг не дублировались в рабочем каталоге ipfs, а использовались прямо на месте

`ipfs config --json Routing.AcceleratedDHTClient true` — для увеличения скорости анонса хранящихся файлов, необходимо при объёме библиотеки больше ~100 MB

`ipfs config --json Swarm.RelayClient.Enabled true` — включаем возможность быть клиентом релеев, чтобы получать файл не обязательно от того кто его хранит, а через цепь релеев

`ipfs config --json Swarm.DisableNatPortMap false` — включаем возможность использования [upnp](https://ru.wikipedia.org/wiki/UPnP) чтобы не возиться с пробросом портов на роутере.

(Вот тут есть загвоздочка — UPnP не всегда по умолчанию включен на роутере, да и не всегда работает как от него ожидается, так что надёжнее всё-таки будет настроить проброс портов — 4001 tcp+udp).

Запускаем **turanga**, она создаёт необходимые файлы в своём месторасположении, файл конфигурации можно сразу поправить по вкусу. Файл конфигурации читается один раз при запуске, при изменении в нём надо перезапускать **turanga**.

Для автоматического запуска **ipfs** и **turanga** в Windows рекомендую использовать [nssm](https://nssm.cc/), в Linux — стандартный systemd.

## Getting started

Интерфейс программы задумывался максимально простым, я поясню только то, что может оказаться неочевидным.

Изначально пароль для управления библиотекой не задан, установить его можно нажав кнопку **->]**

У авторизованного пользователя доступны кнопки добавления книг, запроса через интернет, проведения ревизии; он может добавлять/удалять теги к книгам и редактировать их метаданные. Можно поставить флаг ограничения доступа **18+**, книги с ним не будут показаны неавторизованному пользователю и в opds.

Поначалу библиотека, естественно, пуста; наполнять её можно либо через кнопку **+**, либо скопировав файлы в папку **books** в рабочем каталоге программы и проведя ревизию, либо указав **nibbler**'у нужную папку (кстати, в случае каталога **calibre** он берёт оттуда обложки).

На странице запроса (когда уже пришли ответы) у каждой книги есть три кнопки в столбце Действия; первая скачивает книгу и сразу помещает её в библиотеку, вторая копирует в буфер обмена хеш книги, третья добавляет в чёрный список эту книгу и её раздающего. Это сделано для борьбы с деструктивными действиями, но каждый борется сам, чтобы не возникала "культура отмены".

В ридерах при добавлении нового opds каталога достаточно указать только его адрес с портом, без дополнительных путей, программа сама разберётся кто её запрашивает — http://ip_address_turanga:8698


## Customisation

При первом запуске создаётся конфигурационный файл **turanga.conf** c практически всеми параметрами, необходимыми для работы, кратко о каждом:

**port** = *8698*

Порт, на котором работает **turanga**, указывается в браузере (например http://localhost:8698) или в ридере.

**books_dir** = *./books*

Папка в которой будут храниться файлы книг, файлы обложек и аннотации хранятся в папках covers и notes в рабочем каталоге программы.

**rename_book**                = *autit*

Политика переименования файла книги при её добавлении или при ревизии. Возможные значения: no (не переименовывать), autit (Имя_Автора-Название_книги.ext), hash (xxhash.ext, **nibbler** всегда использует этот способ)

**catalog_title**              = *Turanga - Каталог книг*

Заголовок веб-интерфейса

**local_ipfs_api**             = 127.0.0.1:5001

**local_ipfs_gateway**         = http://127.0.0.1:8080

Параметры локального узла ipfs, можно увидеть запустив в командной строке `ipfs id`

**ipfs_gateway**               = https://dweb.link

Адрес с которым будут формироваться ссылки для скачивания

**remove_from_ipfs_on_delete** = *false*

Удалять ли файл из локальной ноды ipfs при его удалении из turanga

**pagination_threshold**       = *60*

Количество книг на одной странице в web и opds

**nostr_private_key**          = *nsec...*

Приватный ключ nostr, формируется при первом запуске

**nostr_relays**               = *relay.damus.io, wss://relay.primal.net*

Список используемыех релеев nostr

**blacklist_file**             = *blacklist.txt*

Файл чёрного списка

**password_hash**              =

Хеш пароля, формируется при первом вводе его

**max_requests_per_day**       = *10*

Максимальное число запросов в день от другой программы (0 — нет ограничения)

**debug** = *off*

Степень подробностей в логе

С целью сделать бинарник минимальным по объёму, чтобы он не тратил зря память, будучи запущенным в фоне, весь веб-интерфейс вынесен во внешние файлы, включая картинки, шрифты, скрипты и шаблоны. Их можно исправлять на свой вкус, памятуя, что сломать гораздо легче, чем сделать, и сохраняя резервные копии изменяемых файлов. Кстати, приветствуется участие опытного веб-дизайнера, а то и я, и Qwen в этом откровенно слабоваты.

Также хочу предупредить, что с целью уменьшения размера программы, sqlite используется стандартный, без поддержки unicode, поэтому в поиске есть разница в строчных и заглавных буквах.

## PS

Я пытался сделать **turanga** максимально удобной для себя, надеюсь она также окажется удобной для Вас!
